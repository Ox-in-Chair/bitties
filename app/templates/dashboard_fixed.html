{% extends "base.html" %}

{% block title %}Bitties - Dashboard{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <h1>Dashboard</h1>
        
        <!-- Stats Grid -->
        <div class="grid grid-4" style="margin-bottom: 2rem;">
            <div class="stat-card" data-stat="btc-total">
                <div class="stat-label">Total BTC</div>
                <div class="stat-value">0.00000000</div>
            </div>
            
            <div class="stat-card" data-stat="portfolio-value">
                <div class="stat-label">Portfolio Value</div>
                <div class="stat-value">R0</div>
                <div class="stat-change">+0.0%% (24h)</div>
            </div>
            
            <div class="stat-card" data-stat="btc-price">
                <div class="stat-label">BTC Price</div>
                <div class="stat-value">R0</div>
            </div>
            
            <div class="stat-card" data-stat="profit-loss">
                <div class="stat-label">Profit/Loss</div>
                <div class="stat-value">R0</div>
                <div class="stat-change">+0.0%%</div>
            </div>
        </div>
        
        <!-- Goal Progress -->
        <div class="goal-progress" style="margin-bottom: 2rem;">
            <div class="goal-header">
                <h2 class="goal-title">Augusta 2036 Goal</h2>
                <span class="goal-target">Target: R200,000</span>
            </div>
            
            <div class="goal-stats"></div>
            
            <div class="progress">
                <div class="progress-bar">0%%</div>
            </div>
        </div>

        <!-- Members Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Members</h3>
                <button class="btn btn-primary" onclick="document.getElementById^('add-member-modal'^).classList.add^('active'^)">Add Member</button>
            </div>
            <div class="members-grid grid grid-2">
                <!-- Members will be loaded here -->
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Transactions</h3>
                <button class="btn btn-primary" onclick="document.getElementById^('add-transaction-modal'^).classList.add^('active'^)">Add Transaction</button>
            </div>
            <div class="transactions-list"></div>
        </div>
    </div>
</section>

<!-- Add Member Modal -->
<div id="add-member-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Member</h3>
            <span class="modal-close" onclick="this.closest^('.modal'^).classList.remove^('active'^)">&times;</span>
        </div>
        
        <form id="add-member-form">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">Nickname (optional)</label>
                <input type="text" name="nickname" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary">Add Member</button>
            <button type="button" class="btn btn-secondary" onclick="this.closest^('.modal'^).classList.remove^('active'^)">Cancel</button>
        </form>
    </div>
</div>

<!-- Add Member Modal -->
<div id="add-member-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Member</h3>
            <span class="modal-close" onclick="this.closest^('.modal'^).classList.remove^('active'^)">&times;</span>
        </div>
        
        <form id="add-member-form">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label">Nickname (optional)</label>
                <input type="text" name="nickname" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary">Add Member</button>
            <button type="button" class="btn btn-secondary" onclick="this.closest^('.modal'^).classList.remove^('active'^)">Cancel</button>
        </form>
    </div>
</div>

<script>
// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
});

async function loadDashboardData() {
    try {
        // Load all data
        const [portfolioRes, membersRes, transactionsRes] = await Promise.all([
            fetch('/api/portfolio'),
            fetch('/api/members'),
            fetch('/api/transactions')
        ]);
        
        const portfolio = await portfolioRes.json();
        const members = await membersRes.json();
        const transactions = await transactionsRes.json();
        
        // Update stats
        updateStats(portfolio);
        updateGoalProgress(portfolio);
        displayMembers(members);
        displayTransactions(transactions);
        updateMemberSelect(members);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

function updateStats(portfolio) {
    document.querySelector('[data-stat="btc-total"] .stat-value').textContent = portfolio.total_btc.toFixed(8);
    document.querySelector('[data-stat="portfolio-value"] .stat-value').textContent = 'R' + portfolio.current_value_zar.toLocaleString();
    document.querySelector('[data-stat="btc-price"] .stat-value').textContent = 'R' + portfolio.current_btc_price_zar.toLocaleString();
ECHO is on.
    const plElement = document.querySelector('[data-stat="profit-loss"] .stat-value');
    plElement.textContent = 'R' + Math.abs(portfolio.profit_loss_zar).toLocaleString();
    plElement.style.color = portfolio.profit_loss_zar >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
ECHO is on.
    const changeEl = document.querySelector('[data-stat="portfolio-value"] .stat-change');
    changeEl.textContent = (portfolio.profit_loss_percentage >= 0 ? '+' : '') + portfolio.profit_loss_percentage.toFixed(2) + '%% (24h)';
    changeEl.className = portfolio.profit_loss_percentage >= 0 ? 'stat-change positive' : 'stat-change negative';
}

function updateGoalProgress(portfolio) {
    const targetAmount = 200000;
    const currentValue = portfolio.current_value_zar;
    const progress = (currentValue / targetAmount) * 100;
ECHO is on.
    const progressBar = document.querySelector('.progress-bar');
    progressBar.style.width = Math.min(progress, 100) + '%%';
    progressBar.textContent = progress.toFixed(1) + '%%';
}

function displayMembers(members) {
    const container = document.querySelector('.members-grid');
    container.innerHTML = members.map(member => 
        '<div class="member-card">' +
        '<div class="member-avatar">' + member.name.charAt(0).toUpperCase() + '</div>' +
        '<div class="member-info">' +
        '<div class="member-name">' + member.name + (member.nickname ? ' (' + member.nickname + ')' : '') + '</div>' +
        '<div class="member-stats">' +
        '<div class="member-stat"><span class="member-stat-label">Contributed</span>' +
        '<span class="member-stat-value">R' + member.total_contributed.toLocaleString() + '</span></div>' +
        '<div class="member-stat"><span class="member-stat-label">BTC Balance</span>' +
        '<span class="member-stat-value">' + member.btc_balance.toFixed(8) + '</span></div>' +
        '</div></div></div>'
    ).join('');
}

function updateGoalProgress(portfolio) {
    const targetAmount = 200000;
    const currentValue = portfolio.current_value_zar;
    const progress = (currentValue / targetAmount) * 100;
ECHO is on.
    const progressBar = document.querySelector('.progress-bar');
    progressBar.style.width = Math.min(progress, 100) + '%%';
    progressBar.textContent = progress.toFixed(1) + '%%';
}

function displayMembers(members) {
    const container = document.querySelector('.members-grid');
    container.innerHTML = members.map(member => 
        '<div class="member-card">' +
        '<div class="member-avatar">' + member.name.charAt(0).toUpperCase() + '</div>' +
        '<div class="member-info">' +
        '<div class="member-name">' + member.name + (member.nickname ? ' (' + member.nickname + ')' : '') + '</div>' +
        '<div class="member-stats">' +
        '<div class="member-stat"><span class="member-stat-label">Contributed</span>' +
        '<span class="member-stat-value">R' + member.total_contributed.toLocaleString() + '</span></div>' +
        '<div class="member-stat"><span class="member-stat-label">BTC Balance</span>' +
        '<span class="member-stat-value">' + member.btc_balance.toFixed(8) + '</span></div>' +
        '</div></div></div>'
    ).join('');
}

// Handle form submissions
document.getElementById('add-member-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
ECHO is on.
    try {
        await fetch('/api/members', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
ECHO is on.
        document.getElementById('add-member-modal').classList.remove('active');
        e.target.reset();
        loadDashboardData();
    } catch (error) {
        console.error('Error adding member:', error);
    }
});

document.getElementById('add-transaction-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    data.amount_zar = parseFloat(data.amount_zar);
ECHO is on.
    try {
        await fetch('/api/transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
ECHO is on.
        document.getElementById('add-transaction-modal').classList.remove('active');
        e.target.reset();
        loadDashboardData();
    } catch (error) {
        console.error('Error adding transaction:', error);
    }
});
</script>
{% endblock %} 
