{% extends "base.html" %}
{% block title %}Bitties - Dashboard{% endblock %}
{% block content %}
<section class="section">
    <div class="container">
        <h1 style="color: var(--primary-blue); margin-bottom: 2rem;">Bitcoin Investment Dashboard</h1>
        
        <!-- Live Price Section -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2 class="card-title">Live Bitcoin Price</h2>
            <div class="grid grid-2">
                <div class="stat-card">
                    <div class="stat-label">BTC/ZAR</div>
                    <div class="stat-value" id="btc-zar">Loading...</div>
                    <div class="stat-change" id="change-zar"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">BTC/USD</div>
                    <div class="stat-value" id="btc-usd">Loading...</div>
                    <div class="stat-change" id="change-usd"></div>
                </div>
            </div>
        </div>

        <!-- Portfolio Stats -->
        <div class="grid grid-4">
            <div class="stat-card">
                <div class="stat-label">Total BTC</div>
                <div class="stat-value" id="total-btc">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Portfolio Value</div>
                <div class="stat-value" id="portfolio-value">Calculating...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Invested</div>
                <div class="stat-value">R99,600</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Members</div>
                <div class="stat-value">7</div>
            </div>
        </div>

        <!-- Member Contributions -->
        <div class="card" style="margin-top: 2rem;">
            <h3 class="card-title">Member Contributions</h3>
            <div class="grid grid-3" id="members-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="card" style="margin-top: 2rem;">
            <h3>Augusta 2036 Progress</h3>
            <div class="progress" style="margin-top: 1rem;">
                <div class="progress-bar" id="progress-bar" style="width: 0%;">0%</div>
            </div>
            <p style="margin-top: 1rem; color: var(--text-muted);">
                <span id="progress-text">Calculating...</span> of R1,000,000 goal
            </p>
            <p style="margin-top: 0.5rem; color: var(--text-muted);">
                Profit/Loss: <span id="profit-loss" style="font-weight: 600;">Calculating...</span>
            </p>
        </div>
    </div>
</section>

<script>
// Fetch real fund data
async function loadFundData() {
    try {
        const response = await fetch('/api/fund/summary');
        const fundData = await response.json();
        
        // Display member contributions
        const membersContainer = document.getElementById('members-container');
        const memberHtml = Object.entries(fundData.member_contributions)
            .filter(([name, amount]) => amount > 0)
            .sort(([,a], [,b]) => b - a)
            .map(([name, amount]) => {
                const initials = name.split(' ').map(n => n[0]).join('');
                const percentage = (amount / fundData.total_contributions_zar * 100).toFixed(1);
                return `
                    <div class="member-card">
                        <div class="member-avatar">${initials}</div>
                        <div>
                            <div style="font-weight: 600;">${name}</div>
                            <div style="color: var(--text-muted);">R${amount.toLocaleString()} (${percentage}%)</div>
                        </div>
                    </div>
                `;
            }).join('');
        membersContainer.innerHTML = memberHtml;
        
        // Update displayed values
        document.getElementById('total-btc').textContent = fundData.total_btc_acquired.toFixed(8);
        
        // Update displayed values
        document.getElementById('total-btc').textContent = fundData.total_btc_acquired.toFixed(8);
        
        // Store fund data globally
        window.fundData = fundData;
    } catch (error) {
        console.error('Error loading fund data:', error);
    }
}

// Fetch live Bitcoin prices and calculate portfolio
async function updateBitcoinPrices() {
    try {
        const response = await fetch('/api/btc/price');
        const data = await response.json();
        
        // Update prices
        document.getElementById('btc-zar').textContent = `R${data.zar.toLocaleString()}`;
        document.getElementById('btc-usd').textContent = `$${data.usd.toLocaleString()}`;
        
        // Use real BTC amount from fund data
        const totalBTC = window.fundData ? window.fundData.total_btc_acquired : 0;
        const totalInvested = window.fundData ? window.fundData.total_contributions_zar : 0;
        const portfolioValueZAR = totalBTC * data.zar;
        
        document.getElementById('portfolio-value').textContent = `R${Math.round(portfolioValueZAR).toLocaleString()}`;
        
        // Calculate progress
        const goalAmount = 1000000;
        const progressPercent = (portfolioValueZAR / goalAmount) * 100;
        document.getElementById('progress-bar').style.width = Math.min(progressPercent, 100) + '%';
        document.getElementById('progress-bar').textContent = progressPercent.toFixed(1) + '%';
        document.getElementById('progress-text').textContent = `R${Math.round(portfolioValueZAR).toLocaleString()}`;
        
        // Calculate profit/loss
        const profitLoss = portfolioValueZAR - totalInvested;
        const profitLossPercent = (profitLoss / totalInvested) * 100;
        const plElement = document.getElementById('profit-loss');
        plElement.textContent = `R${Math.round(profitLoss).toLocaleString()} (${profitLossPercent > 0 ? '+' : ''}${profitLossPercent.toFixed(1)}%)`;
        plElement.style.color = profitLoss >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        
    } catch (error) {
        console.error('Error fetching Bitcoin price:', error);
        document.getElementById('btc-zar').textContent = 'Error loading';
        document.getElementById('btc-usd').textContent = 'Error loading';
    }
}

// Load everything on page load
window.addEventListener('load', async function() {
    await loadFundData();
    await updateBitcoinPrices();
});

// Update prices every 30 seconds
setInterval(updateBitcoinPrices, 30000);
</script>
{% endblock %}