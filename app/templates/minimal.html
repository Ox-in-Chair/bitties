<!DOCTYPE html>
<html>
<head>
    <title>Bitties Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #0656A3; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: #f0f0f0; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #0656A3; }
        .section { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 8px; }
        button { background: #0656A3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #054488; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .member-item, .tx-item { background: white; padding: 10px; margin: 5px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bitties Dashboard</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div>Total BTC</div>
                <div class="stat-value" id="total-btc">0.00000000</div>
            </div>
            <div class="stat-card">
                <div>Portfolio Value</div>
                <div class="stat-value" id="portfolio-value">R0</div>
            </div>
            <div class="stat-card">
                <div>BTC Price</div>
                <div class="stat-value" id="btc-price">R0</div>
            </div>
            <div class="stat-card">
                <div>Members</div>
                <div class="stat-value" id="member-count">0</div>
            </div>
        </div>

        <div class="section">
            <h2>Quick Add Member</h2>
            <input type="text" id="new-member-name" placeholder="Member name">
            <button onclick="quickAddMember()">Add Member</button>
            <div id="members-list" style="margin-top: 20px;"></div>
        </div>

        <div class="section">
            <h2>Quick Add Transaction</h2>
            <select id="member-select">
                <option value="">Select member</option>
            </select>
            <input type="number" id="amount" placeholder="Amount (ZAR)">
            <button onclick="quickAddTransaction()">Add Transaction</button>
            <div id="transactions-list" style="margin-top: 20px;"></div>
        </div>

        <div class="section">
            <h2>Debug Info</h2>
            <div id="debug"></div>
        </div>
    </div>

    <script>
    // Simple debug logging
    function log(msg) {
        console.log(msg);
        document.getElementById('debug').innerHTML += msg + '<br>';
    }

    // Load data on page load
    window.addEventListener('load', function() {
        log('Page loaded, starting data fetch...');
        loadAllData();
    });

    function loadAllData() {
        // Load portfolio
        fetch('/api/portfolio')
            .then(r => {
                log('Portfolio response: ' + r.status);
                return r.json();
            })
            .then(data => {
                log('Portfolio data received');
                document.getElementById('total-btc').innerText = (data.total_btc || 0).toFixed(8);
                document.getElementById('portfolio-value').innerText = 'R' + (data.current_value_zar || 0).toFixed(0);
                document.getElementById('btc-price').innerText = 'R' + (data.current_btc_price_zar || 0).toFixed(0);
                document.getElementById('member-count').innerText = data.member_count || 0;
            })
            .catch(e => log('Portfolio error: ' + e));

        // Load members
        fetch('/api/members')
            .then(r => {
                log('Members response: ' + r.status);
                return r.json();
            })
            .then(members => {
                log('Members loaded: ' + members.length);
                showMembers(members);
            })
            .catch(e => log('Members error: ' + e));

        // Load transactions
        fetch('/api/transactions')
            .then(r => {
                log('Transactions response: ' + r.status);
                return r.json();
            })
            .then(transactions => {
                log('Transactions loaded: ' + transactions.length);
                showTransactions(transactions);
            })
            .catch(e => log('Transactions error: ' + e));
    }

    function showMembers(members) {
        const list = document.getElementById('members-list');
        const select = document.getElementById('member-select');
        
        if (members.length === 0) {
            list.innerHTML = '<p>No members yet</p>';
            return;
        }
        
        list.innerHTML = members.map(m => 
            '<div class="member-item">' + m.name + ' - R' + (m.total_contributed || 0) + '</div>'
        ).join('');
        
        select.innerHTML = '<option value="">Select member</option>' + 
            members.map(m => '<option value="' + m.id + '">' + m.name + '</option>').join('');
    }

    function showTransactions(transactions) {
        const list = document.getElementById('transactions-list');
        
        if (transactions.length === 0) {
            list.innerHTML = '<p>No transactions yet</p>';
            return;
        }
        
        const recent = transactions.slice(-5);
        list.innerHTML = recent.map(t => 
            '<div class="tx-item">R' + t.amount_zar + ' - ' + t.amount_btc.toFixed(8) + ' BTC</div>'
        ).join('');
    }

    function quickAddMember() {
        const name = document.getElementById('new-member-name').value;
        if (!name) {
            alert('Enter a name');
            return;
        }
        
        fetch('/api/members', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name, status: 'active'})
        })
        .then(r => r.json())
        .then(data => {
            log('Member added: ' + data.name);
            document.getElementById('new-member-name').value = '';
            loadAllData();
        })
        .catch(e => log('Add member error: ' + e));
    }

    function quickAddTransaction() {
        const memberId = document.getElementById('member-select').value;
        const amount = parseFloat(document.getElementById('amount').value);
        
        if (!memberId || !amount) {
            alert('Select member and enter amount');
            return;
        }
        
        fetch('/api/transactions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'contribution',
                member_id: memberId,
                amount_zar: amount
            })
        })
        .then(r => r.json())
        .then(data => {
            log('Transaction added');
            document.getElementById('amount').value = '';
            loadAllData();
        })
        .catch(e => log('Add transaction error: ' + e));
    }
    </script>
</body>
</html>